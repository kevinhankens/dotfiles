From 68f771a7219e4a84d6bf2a48169c523a5d3e0ef1 Mon Sep 17 00:00:00 2001
From: Katherine Bailey <katherine@katbailey.net>
Date: Tue, 17 Apr 2012 21:14:23 -0700
Subject: [PATCH] Preventing ajax error due to PDO exception  when widget is
 clicked during node preview

---
 fivestar.module |    7 +++++--
 1 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/fivestar.module b/fivestar.module
index 418b7a9..9bcd0f0 100644
--- a/fivestar.module
+++ b/fivestar.module
@@ -408,8 +408,11 @@ function fivestar_form_submit($form, &$form_state) {
  * AJAX submit handler for fivestar_custom_widget
  */
 function fivestar_ajax_submit($form, $form_state) {
-  _fivestar_update_field_value($form_state['settings']['content_type'], $form_state['settings']['entity'], $form_state['settings']['field_name'], $form_state['settings']['langcode'], $form_state['values']['vote']);
-  $votes = _fivestar_cast_vote($form_state['settings']['content_type'], $form_state['settings']['content_id'], $form_state['values']['vote'], $form_state['settings']['tag']);
+  if (!empty($form_state['settings']['content_id'])) {
+    _fivestar_update_field_value($form_state['settings']['content_type'], $form_state['settings']['entity'], $form_state['settings']['field_name'], $form_state['settings']['langcode'], $form_state['values']['vote']);
+    $votes = _fivestar_cast_vote($form_state['settings']['content_type'], $form_state['settings']['content_id'], $form_state['values']['vote'], $form_state['settings']['tag']);
+  }
+
 
   $values = array();
   $values['user'] = isset($votes['user']['value']) ? $votes['user']['value'] : 0;
-- 
1.7.5.4

